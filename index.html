<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testes de Seguran칞a AVAN칂ADOS do Console - Por Desenvolvedor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #cc0000;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #dc3545;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #c82333;
        }
        .refresh-button {
            background-color: #007bff; /* Azul para o bot칚o de refresh */
            margin-bottom: 20px;
        }
        .refresh-button:hover {
            background-color: #0056b3;
        }
        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: calc(70% - 10px);
            box-sizing: border-box;
            margin-bottom: 5px; /* Adicionado para espa칞amento */
        }
        textarea {
            width: 98%;
            height: 100px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        pre {
            background-color: #e2e2e2;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }
        .result {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
        .success-message {
            color: green;
            font-weight: bold;
        }
        canvas {
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="refresh-button" onclick="location.reload()">游댃 Atualizar P치gina</button>

        <h1>丘멆잺 Testes de Seguran칞a AVAN칂ADOS do Navegador do Console 丘멆잺</h1>
        <p>Estes testes s칚o mais agressivos e podem potencialmente causar instabilidade no navegador ou no console. **Prossiga com cautela.**</p>

        ---

        <h2>1. Teste de Fragmenta칞칚o de Mem칩ria e Objetos Pesados</h2>
        <p>Cria e descarta muitos objetos complexos. Pode levar a lentid칚o ou travamentos se o coletor de lixo n칚o for eficiente.</p>
        <button onclick="startMemoryFragmentationTest()">Iniciar Teste</button>
        <button onclick="stopMemoryFragmentationTest()">Parar Teste</button>
        <div id="fragMemStatus" class="result">Status: Inativo</div>

        ---

        <h2>2. Teste de Carregamento de Recursos Excessivos/Inv치lidos</h2>
        <p>Tenta carregar um n칰mero absurdo de elementos HTML (imagens, divs) ou recursos inv치lidos. Observar consumo de CPU/Mem칩ria.</p>
        <input type="number" id="numElements" value="10000" min="1000" max="100000" step="1000">
        <button onclick="loadExcessiveElements()">Carregar Elementos HTML</button>
        <button onclick="loadInvalidImage()">Carregar Imagem Inv치lida</button>
        <div id="excessiveLoadStatus" class="result">Status: Aguardando...</div>
        <div id="elementContainer"></div>

        ---

        <h2>3. Teste de Web Workers (Processamento em Segundo Plano)</h2>
        <p>Inicia um Web Worker para fazer c치lculos pesados. Verifica se o navegador continua responsivo e se o worker 칠 isolado.</p>
        <button onclick="startWorkerStress()">Iniciar Worker Stress</button>
        <button onclick="stopWorkerStress()">Parar Worker Stress</button>
        <div id="workerStatus" class="result">Status: Inativo</div>

        ---

        <h2>4. Teste de Exaust칚o de Conex칫es de Rede (WebSockets)</h2>
        <p>Tenta abrir e manter um grande n칰mero de conex칫es WebSocket. Pode esgotar limites de conex칚o do sistema.</p>
        <input type="number" id="numWebsockets" value="500" min="10" max="2000" step="10">
        <button onclick="startWebSocketExhaustion()">Iniciar Exaust칚o WS</button>
        <button onclick="closeAllWebSockets()">Fechar Todos WS</button>
        <div id="wsExhaustStatus" class="result">Status: Inativo</div>

        ---

        <h2>5. Teste de Iframe Sandbox Bypass</h2>
        <p>Carrega iframes com diferentes atributos de sandbox. Verifique se o conte칰do do iframe pode quebrar o isolamento.</p>
        <button onclick="testIframeSandbox()">Testar Iframes</button>
        <div id="iframeSandboxStatus" class="result">Status: Aguardando...</div>

        ---

        <h2>6. Teste de Estresse Gr치fico (Canvas Animado)</h2>
        <p>Desenha anima칞칫es complexas em um canvas para estressar o motor de renderiza칞칚o do navegador.</p>
        <button onclick="startGraphicsStress()">Iniciar Estresse Gr치fico</button>
        <button onclick="stopGraphicsStress()">Parar Estresse Gr치fico</button>
        <canvas id="graphicsCanvas" width="400" height="200" style="border: 1px solid black; background-color: #eee;"></canvas>
        <div id="graphicsStatus" class="result">Status: Inativo</div>

        ---

        <h2>Resultados do Console (Log):</h2>
        <pre id="consoleLog"></pre>
    </div>

    <script>
        // Fun칞칚o de log aprimorada
        const consoleLogElement = document.getElementById('consoleLog');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            let color = 'black';
            if (type === 'error') color = 'red';
            if (type === 'success') color = 'green';
            // Certifica-se de que o elemento existe antes de tentar manipular
            if (consoleLogElement) {
                consoleLogElement.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
                consoleLogElement.scrollTop = consoleLogElement.scrollHeight; // Auto-scroll
            } else {
                // Fallback para console.log se o elemento n칚o for encontrado
                console.log(`[${timestamp}] ${message}`);
            }
        }

        // Adicionado um log inicial para confirmar que o script est치 rodando
        document.addEventListener('DOMContentLoaded', (event) => {
            log('P치gina carregada e JavaScript iniciado!', 'info');
        });

        // --- Teste 1: Teste de Fragmenta칞칚o de Mem칩ria e Objetos Pesados ---
        let fragMemInterval;
        let runningFragMemTest = false;
        let generatedObjects = [];

        function startMemoryFragmentationTest() {
            if (runningFragMemTest) {
                log('Teste Fragmenta칞칚o de Mem칩ria j치 est치 rodando.', 'info');
                return;
            }
            runningFragMemTest = true;
            document.getElementById('fragMemStatus').textContent = 'Status: Gerando e destruindo objetos... Observar lentid칚o.';
            log('Teste Frag. Mem칩ria: Iniciando...', 'info');

            let counter = 0;
            fragMemInterval = setInterval(() => {
                try {
                    const bigObject = {
                        data: new Uint32Array(1024 * 1024 / 4), // 1MB de dados
                        metadata: {
                            id: counter++,
                            timestamp: Date.now(),
                            randomString: Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
                        }
                    };
                    generatedObjects.push(bigObject);

                    if (generatedObjects.length > 200 && generatedObjects.length % 100 === 0) {
                        generatedObjects.splice(0, 50);
                        log(`Teste Frag. Mem칩ria: Gerados ${counter} objetos, ${generatedObjects.length} ativos. For칞ando GC...`, 'info');
                    }
                    if (generatedObjects.length > 500) {
                        generatedObjects.splice(0, 100);
                    }
                    document.getElementById('fragMemStatus').textContent = `Status: Gerando e destruindo objetos... Total gerado: ${counter}`;

                } catch (e) {
                    log(`Teste Frag. Mem칩ria: Erro durante a gera칞칚o: ${e.message}. Parando teste.`, 'error');
                    stopMemoryFragmentationTest();
                }
            }, 50);
        }

        function stopMemoryFragmentationTest() {
            if (!runningFragMemTest) return;
            runningFragMemTest = false;
            clearInterval(fragMemInterval);
            generatedObjects = [];
            document.getElementById('fragMemStatus').textContent = 'Status: Parado. Mem칩ria liberada.';
            log('Teste Frag. Mem칩ria: Parado. Objetos liberados.', 'success');
        }

        // --- Teste 2: Teste de Carregamento de Recursos Excessivos/Inv치lidos ---
        function loadExcessiveElements() {
            const numElements = parseInt(document.getElementById('numElements').value);
            const elementContainer = document.getElementById('elementContainer');
            const excessiveLoadStatus = document.getElementById('excessiveLoadStatus');
            elementContainer.innerHTML = '';
            log(`Teste Excesso de Elementos: Carregando ${numElements} elementos HTML...`, 'info');
            excessiveLoadStatus.textContent = `Status: Carregando ${numElements} elementos... (Pode travar)`;

            let count = 0;
            const startTime = Date.now();

            function addElementChunk() {
                try {
                    const fragment = document.createDocumentFragment();
                    for (let i = 0; i < 1000 && count < numElements; i++) {
                        const div = document.createElement('div');
                        div.style.width = '1px';
                        div.style.height = '1px';
                        div.style.backgroundColor = 'blue';
                        div.style.display = 'inline-block';
                        fragment.appendChild(div);
                        count++;
                    }
                    elementContainer.appendChild(fragment);

                    if (count < numElements) {
                        requestAnimationFrame(addElementChunk);
                    } else {
                        const endTime = Date.now();
                        log(`Teste Excesso de Elementos: Carregados ${numElements} elementos em ${endTime - startTime}ms.`, 'success');
                        excessiveLoadStatus.textContent = `Status: Carregados ${numElements} elementos. Observar consumo de recursos.`;
                    }
                    excessiveLoadStatus.textContent = `Status: Carregados ${count}/${numElements} elementos.`;
                } catch (e) {
                    log(`Teste Excesso de Elementos: Erro ao adicionar elementos: ${e.message}. Parando.`, 'error');
                    excessiveLoadStatus.textContent = `Status: ERRO ao carregar elementos: ${e.message}`;
                }
            }
            requestAnimationFrame(addElementChunk);
        }

        function loadInvalidImage() {
            const excessiveLoadStatus = document.getElementById('excessiveLoadStatus');
            const elementContainer = document.getElementById('elementContainer');
            elementContainer.innerHTML = '';

            log('Teste Imagem Inv치lida: Tentando carregar imagem com dados corrompidos...', 'info');
            excessiveLoadStatus.textContent = 'Status: Tentando carregar imagem inv치lida...';

            const img = new Image();
            img.onload = () => {
                log('Teste Imagem Inv치lida: ATEN칂츾O! Imagem inv치lida carregada com sucesso! Isso pode indicar falha no parser de imagem.', 'error');
                excessiveLoadStatus.textContent = 'Status: Imagem inv치lida carregada (Problema!)';
                elementContainer.appendChild(img);
            };
            img.onerror = () => {
                log('Teste Imagem Inv치lida: Falha ao carregar imagem inv치lida. (Comportamento esperado)', 'success');
                excessiveLoadStatus.textContent = 'Status: Falha ao carregar imagem inv치lida (OK)';
            };
            img.src = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBD';
        }

        // --- Teste 3: Teste de Web Workers (Processamento em Segundo Plano) ---
        let worker;
        let workerRunning = false;
        function startWorkerStress() {
            if (workerRunning) {
                log('Web Worker j치 est치 rodando.', 'info');
                return;
            }
            workerRunning = true;
            document.getElementById('workerStatus').textContent = 'Status: Iniciando Web Worker...';
            log('Teste Web Worker: Iniciando...', 'info');

            const workerScriptContent = `
                onmessage = function(e) {
                    if (e.data === 'start') {
                        let result = 0;
                        try {
                            for (let i = 0; i < 5000000000; i++) {
                                result += Math.sqrt(i);
                            }
                            postMessage('done');
                        } catch (err) {
                            postMessage({ type: 'error', message: err.message });
                        }
                    }
                };
            `;
            const blob = new Blob([workerScriptContent], { type: 'application/javascript' });
            worker = new Worker(URL.createObjectURL(blob));

            worker.onmessage = (e) => {
                if (e.data === 'done') {
                    document.getElementById('workerStatus').textContent = 'Status: Web Worker terminou o processamento pesado.';
                    log('Teste Web Worker: Processamento pesado conclu칤do pelo worker.', 'success');
                    workerRunning = false;
                    worker.terminate();
                } else if (e.data.type === 'error') {
                    document.getElementById('workerStatus').textContent = `Status: Erro no Web Worker: ${e.data.message}`;
                    log(`Teste Web Worker: Erro no worker: ${e.data.message}.`, 'error');
                    workerRunning = false;
                    worker.terminate();
                }
            };
            worker.onerror = (e) => {
                document.getElementById('workerStatus').textContent = `Status: Erro fatal no Web Worker: ${e.message}`;
                log(`Teste Web Worker: Erro FATAL no worker: ${e.message}.`, 'error');
                workerRunning = false;
            };

            worker.postMessage('start');
            document.getElementById('workerStatus').textContent = 'Status: Web Worker rodando c치lculo pesado. Navegador deve permanecer responsivo.';
        }

        function stopWorkerStress() {
            if (!workerRunning) return;
            log('Teste Web Worker: Solicitando parada (pode n칚o parar imediatamente se o c치lculo for muito pesado)...', 'info');
            if (worker) {
                worker.terminate();
                workerRunning = false;
                document.getElementById('workerStatus').textContent = 'Status: Web Worker parado (terminado).';
                log('Teste Web Worker: Worker terminado.', 'success');
            }
        }

        // --- Teste 4: Teste de Exaust칚o de Conex칫es de Rede (WebSockets) ---
        let activeWebSockets = [];
        let wsExhaustionRunning = false;
        function startWebSocketExhaustion() {
            if (wsExhaustionRunning) {
                log('Teste Exaust칚o de WS j치 est치 rodando.', 'info');
                return;
            }
            wsExhaustionRunning = true;
            const numWebsockets = parseInt(document.getElementById('numWebsockets').value);
            const wsExhaustStatus = document.getElementById('wsExhaustStatus');
            wsExhaustStatus.textContent = `Status: Abrindo ${numWebsockets} WebSockets...`;
            log(`Teste Exaust칚o WS: Tentando abrir ${numWebsockets} conex칫es...`, 'info');

            activeWebSockets = [];
            let openedCount = 0;
            let errorCount = 0;
            let closedCount = 0;

            const targetWsUrl = 'ws://echo.websocket.events';

            for (let i = 0; i < numWebsockets; i++) {
                try {
                    const ws = new WebSocket(targetWsUrl);
                    activeWebSockets.push(ws);

                    ws.onopen = () => {
                        openedCount++;
                        updateWsExhaustStatus();
                    };
                    ws.onerror = (e) => {
                        errorCount++;
                        updateWsExhaustStatus();
                        // log(`WS ${i} erro: ${e.message || 'Desconhecido'}`, 'error'); // Descomentar para logs individuais
                    };
                    ws.onclose = () => {
                        closedCount++;
                        updateWsExhaustStatus();
                        // log(`WS ${i} fechado.`, 'info'); // Descomentar para logs individuais
                    };
                } catch (e) {
                    errorCount++;
                    log(`Teste Exaust칚o WS: Erro ao iniciar WS ${i}: ${e.message}`, 'error');
                }
            }
            log(`Teste Exaust칚o WS: Tentativa de abrir ${numWebsockets} WebSockets conclu칤da.`, 'success');

            function updateWsExhaustStatus() {
                wsExhaustStatus.textContent = `Status: Tentando abrir ${numWebsockets}. Abertas: ${openedCount}. Fechadas: ${closedCount}. Erros: ${errorCount}.`;
            }
        }

        function closeAllWebSockets() {
            if (!wsExhaustionRunning) return;
            log('Teste Exaust칚o WS: Fechando todas as conex칫es WebSocket...', 'info');
            activeWebSockets.forEach(ws => {
                if (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING) {
                    ws.close();
                }
            });
            activeWebSockets = [];
            wsExhaustionRunning = false;
            document.getElementById('wsExhaustStatus').textContent = 'Status: Todas as conex칫es WebSocket fechadas.';
            log('Teste Exaust칚o WS: Todas as conex칫es fechadas.', 'success');
        }

        // --- Teste 5: Teste de Iframe Sandbox Bypass ---
        function testIframeSandbox() {
            const iframeSandboxStatus = document.getElementById('iframeSandboxStatus');
            iframeSandboxStatus.innerHTML = 'Status: Iniciando testes de iframe sandbox...<br>';
            log('Teste Iframe Sandbox: Iniciando...', 'info');

            const testConfigs = [
                { id: 'iframe1', title: 'Nenhum Sandbox (Perigoso)', sandbox: '' },
                { id: 'iframe2', title: 'Sandbox Sem Scripts (Esperado que falhe alerta)', sandbox: 'allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-top-navigation-by-user-activation' }, // Removido 'allow-scripts'
                { id: 'iframe3', title: 'Sandbox Com Scripts (Esperado que mostre alerta)', sandbox: 'allow-scripts allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-top-navigation-by-user-activation' }
            ];

            testConfigs.forEach(config => {
                const iframe = document.createElement('iframe');
                iframe.id = config.id;
                iframe.width = '300';
                iframe.height = '100';
                iframe.style.border = '1px solid black';
                iframe.sandbox = config.sandbox;
                iframe.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head><title>${config.title}</title></head>
                    <body>
                        <h3>${config.title}</h3>
                        <p id="message">Teste...</p>
                        <script>
                            try {
                                if (window.parent !== window) {
                                    document.getElementById('message').textContent += ' | Acesso ao parent OK.';
                                } else {
                                    document.getElementById('message').textContent += ' | Acesso ao parent BLOQUEADO (Esperado com sandbox).';
                                }
                                setTimeout(() => { alert('${config.title} - Script Executado!'); }, 500);
                                document.getElementById('message').textContent += ' | Alerta agendado.';
                            } catch (e) {
                                document.getElementById('message').textContent += ' | Erro no script: ' + e.message;
                            }
                            // Tentativa de navegar a janela principal (top-level navigation)
                            // if (window.top) {
                            //     try {
                            //         // Isso s칩 deveria funcionar com allow-top-navigation ou allow-top-navigation-by-user-activation
                            //         // e geralmente n칚o por script sem user interaction
                            //         // window.top.location.href = 'https://www.google.com';
                            //         // document.getElementById('message').textContent += ' | Tentativa de top-navigation.';
                            //     } catch (e) {
                            //         document.getElementById('message').textContent += ' | Top-navigation BLOQUEADO (Esperado).';
                            //     }
                            // }
                        </script>
                    </body>
                    </html>
                `;

                iframe.onload = () => {
                    log(`Iframe ${config.title}: Carregado.`, 'info');
                    try {
                        const iframeDoc = iframe.contentWindow.document;
                        const messageElement = iframeDoc.getElementById('message');
                        log(`Iframe ${config.title}: Mensagem interna: "${messageElement ? messageElement.textContent : 'N칚o acess칤vel'}"`, 'info');
                    } catch (e) {
                        log(`Iframe ${config.title}: Bloqueado pelo Same-Origin Policy (esperado para sandbox sem allow-same-origin). Erro: ${e.message}`, 'success');
                    }
                };
                iframe.onerror = () => {
                    log(`Iframe ${config.title}: Erro ao carregar.`, 'error');
                };

                document.getElementById('iframeSandboxStatus').appendChild(iframe);
                document.getElementById('iframeSandboxStatus').innerHTML += `<br>`;
            });
            log('Teste Iframe Sandbox: Testes iniciados. Observe os comportamentos dos iframes.', 'success');
        }

        // --- Teste 6: Teste de Estresse Gr치fico (Canvas Animado) ---
        // Este teste foi renumerado de 9 para 6.
        let animationFrameId;
        let isGraphicsStressRunning = false;
        function startGraphicsStress() {
            if (isGraphicsStressRunning) return;
            isGraphicsStressRunning = true;

            const canvas = document.getElementById('graphicsCanvas');
            const ctx = canvas.getContext('2d');
            const graphicsStatus = document.getElementById('graphicsStatus');
            log('Teste Gr치fico: Iniciando estresse gr치fico...', 'info');
            graphicsStatus.textContent = 'Status: Rodando... (Observar desempenho e estabilidade)';

            let angle = 0;
            const draw = () => {
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    for (let i = 0; i < 50; i++) {
                        const x = canvas.width / 2 + Math.cos(angle + i * 0.1) * (100 + i * 0.5);
                        const y = canvas.height / 2 + Math.sin(angle + i * 0.1) * (50 + i * 0.2);
                        const radius = 5 + Math.sin(angle * 0.5 + i * 0.2) * 3;

                        ctx.beginPath();
                        ctx.arc(x, y, radius, 0, Math.PI * 2);
                        ctx.fillStyle = `hsl(${angle * 10 % 360}, 70%, 50%)`;
                        ctx.fill();
                    }

                    angle += 0.05;
                    animationFrameId = requestAnimationFrame(draw);
                } catch (e) {
                    log(`Teste Gr치fico: Erro durante a renderiza칞칚o: ${e.message}. Parando.`, 'error');
                    stopGraphicsStress();
                }
            };

            animationFrameId = requestAnimationFrame(draw);
        }

        function stopGraphicsStress() {
            if (!isGraphicsStressRunning) return;
            isGraphicsStressRunning = false;
            cancelAnimationFrame(animationFrameId);
            document.getElementById('graphicsStatus').textContent = 'Status: Inativo';
            log('Teste Gr치fico: Estresse gr치fico parado.', 'info');
        }
    </script>
</body>
</html>
